#!/bin/sh
if ! cd `dirname $0`; then
	echo "Could not cd to scripts directory."
	exit 1
fi

. ./zfsci.conf

ROOTPART=${INSTALLDEV}1

# make sure old partitions aren't mounted anymore
umount /mnt/dev /mnt/sys /mnt/proc /mnt

# try and mount the / file system
if ! mount $ROOTPART /mnt; then
	echo "Couldn't mount root fs."
	exit 1
fi

if [ ! -e /mnt/.zfsci ]; then
	echo "There are no test results on this device."
	umount /mnt
	exit 1
fi

# mark the tests as 'finished'
rm -f /mnt/.zfsci

chroot /mnt /opt/zfsci/zfsci-run-stage post

TESTID=`cat /mnt/var/lib/zfsci/testid`
if [ -z "$TESTID" ]; then
	echo "Error: Test ID is empty."
	exit 1
fi

RESULTDIR=/var/lib/zfsci/result-$TESTID
mkdir -p $RESULTDIR
cp -a /mnt/var/lib/zfsci/* $RESULTDIR

exit 0
