#!/bin/sh
if ! cd `dirname $0`; then
	echo "Could not cd to scripts directory."
	exit 1
fi

. ./zfsci.conf

# try and mount the / file system
if ! ./zfsci-mount-node; then
	echo "Node root FS could not be mounted."
	exit 1
fi

if [ ! -e /mnt/.zfsci ]; then
	echo "There are no test results on this device."
	exit 1
fi

# mark the tests as 'finished'
rm -f /mnt/.zfsci

# mount persistent dir
mkdir -p /mnt/var/lib/zfsci-data
mount --bind /var/lib/zfsci-data /mnt/var/lib/zfsci-data

# run post tasks
chroot /mnt /opt/zfsci/zfsci-run-stage /opt/zfsci/tasks post /opt/zfsci/job.json

# copy results
TESTID=`date +%s`
RESULTDIR=/var/lib/zfsci-data/results/result-$TESTID
mkdir -p $RESULTDIR
cp -a /mnt/opt/zfsci/result_files/* $RESULTDIR
cp /mnt/opt/zfsci/job.json $RESULTDIR

exit 0
