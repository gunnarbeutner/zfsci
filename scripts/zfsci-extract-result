#!/bin/sh
if ! cd `dirname $0`; then
	echo "Could not cd to scripts directory."
	exit 1
fi

. ./zfsci.conf

# try and mount the / file system
if ! ./zfsci-mount-node; then
	echo "Node root FS could not be mounted."
	exit 1
fi

if [ ! -e /mnt/.zfsci ]; then
	echo "There are no test results on this device."
	exit 1
fi

# mark the tests as 'finished'
rm -f /mnt/.zfsci

chroot /mnt /opt/zfsci/zfsci-run-stage /opt/zfsci/tasks post /opt/zfsci/job.json

TESTID=`cat /mnt/opt/zfsci/output_files/testid`
if [ -z "$TESTID" ]; then
	echo "Error: Test ID is empty."
	exit 1
fi

RESULTDIR=/var/lib/zfsci/result-$TESTID
mkdir -p $RESULTDIR
cp -a /mnt/opt/zfsci/result_files/* $RESULTDIR
cp /mnt/opt/zfsci/job.json $RESULTDIR

exit 0
