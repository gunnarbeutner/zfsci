#!/bin/sh
if ! cd `dirname $0`; then
	echo "Could not cd to scripts directory."
	exit 1
fi

. ./zfsci.conf

if [ "$1" != "DESTROY" ]; then
	echo "Syntax: $0 DESTROY"
	echo "Installs a zfsci node. All data on the configured" \
		"device is destroyed in the process."
	exit 1
fi

ROOTPART=${INSTALLDEV}1
SWAPPART=${INSTALLDEV}2
POOLPART=${INSTALLDEV}3

# make sure old partitions aren't mounted anymore
./zfsci-unmount-node

# destroy old partition table
dd if=/dev/zero of=$INSTALLDEV bs=512 count=1

# create new partitions
parted --script -- $INSTALLDEV mktable msdos
parted --script -- $INSTALLDEV mkpart primary ext2 1M 10G
parted --script -- $INSTALLDEV mkpart primary linux-swap 10G 14G
parted --script -- $INSTALLDEV mkpart primary sun-ufs 14G -1s

# create / file system and swap
mke2fs -j -m 0 -L / -I 128 $ROOTPART
mkswap $SWAPPART

# try and mount the / file system
if ! ./zfsci-mount-node; then
	echo "Node root FS could not be mounted."
	exit 1
fi

# mark the tests as 'in progress'
touch /mnt/.zfsci

# install base system
if ! debootstrap squeeze /mnt  $DEBIAN_MIRROR; then
	echo "debootstrap failed."
	exit 1
fi

# set hostname
echo $NODE_HOSTNAME > /mnt/etc/hostname

# set up fstab
cat > /mnt/etc/fstab <<FSTAB
$ROOTPART		/			ext3	defaults	0	0
$SWAPPART		none			swap	sw		0	0
$NFS_PERSISTENT_PATH	/var/lib/zfsci-data	nfs	ro		0	0
FSTAB

mkdir -p /mnt/var/lib/zfsci-data

# set up networking
cat > /mnt/etc/network/interfaces <<INTERFACES
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
INTERFACES

# set root password
grep -v ^root /mnt/etc/shadow > /mnt/etc/.shadow &&
	grep ^root /etc/shadow >> /mnt/etc/.shadow &&
	cat /mnt/etc/.shadow > /mnt/etc/shadow &&
	rm -f /mnt/etc/.shadow

# disable cron
chroot /mnt update-rc.d -f cron remove

# update package lists
mount --bind /dev /mnt/dev
mount --bind /sys /mnt/sys
mount -t proc none /mnt/proc
chroot /mnt aptitude update

# make sure python is installed
chroot /mnt aptitude install -y python

# install NFS client
chroot /mnt aptitude install -y nfs-client

# install kdump
# interestingly kdump-tools uses 'file' but doesn't have a
# package dependency for it
chroot /mnt aptitude install -y kdump-tools file initramfs-tools

# build initrd for the crash kernel and move files
# to /crashkernel
CRASHKERNEL="vmlinuz-`uname -r`"
CRASHINITRD="initrd.img-`uname -r`"
cp /boot/$CRASHKERNEL /mnt/boot
cp -a /lib/modules/`uname -r` /mnt/lib/modules
chroot /mnt update-initramfs -c -k `uname -r`
mkdir -p /mnt/crashkernel
mv /mnt/boot/$CRASHKERNEL /mnt/boot/$CRASHINITRD /mnt/crashkernel

mkdir -p /mnt/var/crash

cat >> /mnt/etc/default/kdump-tools <<KDUMP
USE_KDUMP=1
KDUMP_SYSCTL="kernel.panic_on_oops=1"
MAKEDUMP_ARGS="-c -d 31"

KDUMP_KERNEL="/crashkernel/$CRASHKERNEL"
KDUMP_INITRD="/crashkernel/$CRASHINITRD"
KDUMP

cat >> /mnt/etc/default/kexec <<KEXEC
LOAD_KEXEC=false
KEXEC

# install test launcher
cat > /mnt/etc/rc.local <<RCLOCAL
#!/bin/sh
[ -e /.zfsci ] && /opt/zfsci/zfsci-run-stage /opt/zfsci/tasks test /opt/zfsci/job.json

/opt/zfsci/zfsci-watchdog 120
reboot

exit 0
RCLOCAL

exit 0
