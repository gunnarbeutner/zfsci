#!/usr/bin/env python
import os
import sys
import shutil
from partlib import PartitionBuilder

if len(sys.argv) < 2:
	print "Syntax: %s <config>" % (sys.argv[0])
	sys.exit(1)

configfile = sys.argv[1]

if not os.path.isfile(configfile):
	print "The specified config file does not exist."
	sys.exit(1)

PartitionBuilder.mount_partitions()

# mark the tests as 'in progress'
open("/mnt/.zfsci", "w").close()

# symlink zfsci scripts
if not os.path.islink("/mnt/opt/zfsci"):
	os.symlink("/var/lib/zfsci-data/scripts", "/mnt/opt/zfsci")

# copy test config
try:
	os.makedirs("/mnt/var/lib/zfsci")
except OSError:
	pass

shutil.copy(configfile, "/mnt/var/lib/zfsci/job.json")

# run build tasks
if os.system("chroot /mnt /opt/zfsci/zfsci-run-stage /var/lib/zfsci-data/tasks build /var/lib/zfsci/job.json") != 0:
	print "Could not run build tasks."
	sys.exit(1)

sys.exit(0)
